// Advent of Code 2020: day 9

// Godbolt link: https://godbolt.org/z/hn8bPr

#include <algorithm>
#include <cstdint>
#include <iterator>
#include <unordered_set>
#include <vector>
#include <fmt/core.h>

using Int = std::int64_t; 

bool is_valid(Int const n, std::unordered_set<Int> const& pool) {
  return std::any_of(begin(pool), end(pool), [&](int const i) {
    return pool.contains(n - i);
  });
}

Int first_invalid(std::vector<Int> const& v, std::size_t const preamble) {
  std::unordered_set<Int> pool;
  std::copy_n(begin(v), preamble, std::inserter(pool, end(pool)));
  for (auto it = std::next(begin(v), preamble); it != end(v); ++it) {
    auto const i = *it;
    if (!is_valid(i, pool)) return i;
    pool.erase(*std::prev(it, preamble));
    pool.insert(i);
  }
  std::abort(); // no result
}

auto get_range(std::vector<Int> const& v, Int const n)
->  std::pair<std::vector<Int>::const_iterator, std::vector<Int>::const_iterator>
{
  for (auto first = begin(v); std::next(first) != end(v); ++first) {
      Int sum = *first;
    for (auto last = std::next(first); last != end(v); ++last) {
      sum += *last;
      if (sum == n) return {first, std::next(last)};
      if (sum > n) break; // advance first and restart
    }
  }
  std::abort(); // no result
}

std::pair<Int, Int> get_range_boundaries(std::vector<Int> const& v, Int const n) {
  auto const [first, last] = get_range(v, n);
  auto const l = *min_element(first, last);
  auto const h = *max_element(first, last);
  return {l, h};
}

//////////////////////////////////////////////////////////////////////

int main() {

auto const test = std::vector<Int>
{ 35LL
, 20LL
, 15LL
, 25LL
, 47LL
, 40LL
, 62LL
, 55LL
, 65LL
, 95LL
, 102LL
, 117LL
, 150LL
, 182LL
, 127LL
, 219LL
, 299LL
, 277LL
, 309LL
, 576LL
};

auto const input = std::vector<Int>
{ 33LL
, 12LL
, 43LL
, 4LL
, 19LL
, 48LL
, 21LL
, 13LL
, 29LL
, 34LL
, 20LL
, 24LL
, 25LL
, 40LL
, 28LL
, 31LL
, 38LL
, 2LL
, 50LL
, 11LL
, 44LL
, 49LL
, 42LL
, 16LL
, 41LL
, 46LL
, 54LL
, 35LL
, 6LL
, 15LL
, 8LL
, 47LL
, 10LL
, 22LL
, 17LL
, 60LL
, 19LL
, 12LL
, 13LL
, 14LL
, 18LL
, 28LL
, 20LL
, 25LL
, 21LL
, 23LL
, 27LL
, 39LL
, 24LL
, 16LL
, 26LL
, 29LL
, 40LL
, 30LL
, 37LL
, 31LL
, 33LL
, 43LL
, 32LL
, 34LL
, 44LL
, 41LL
, 49LL
, 35LL
, 36LL
, 52LL
, 61LL
, 53LL
, 42LL
, 76LL
, 45LL
, 50LL
, 46LL
, 47LL
, 48LL
, 55LL
, 93LL
, 80LL
, 67LL
, 89LL
, 142LL
, 69LL
, 74LL
, 75LL
, 70LL
, 149LL
, 71LL
, 77LL
, 78LL
, 81LL
, 242LL
, 111LL
, 88LL
, 87LL
, 91LL
, 94LL
, 155LL
, 95LL
, 119LL
, 137LL
, 188LL
, 136LL
, 162LL
, 138LL
, 139LL
, 140LL
, 146LL
, 164LL
, 221LL
, 172LL
, 148LL
, 159LL
, 215LL
, 228LL
, 168LL
, 175LL
, 182LL
, 229LL
, 278LL
, 305LL
, 340LL
, 214LL
, 370LL
, 277LL
, 273LL
, 275LL
, 282LL
, 310LL
, 302LL
, 288LL
, 286LL
, 321LL
, 568LL
, 307LL
, 631LL
, 357LL
, 845LL
, 343LL
, 350LL
, 612LL
, 389LL
, 598LL
, 643LL
, 535LL
, 561LL
, 620LL
, 552LL
, 662LL
, 548LL
, 885LL
, 557LL
, 570LL
, 678LL
, 574LL
, 593LL
, 671LL
, 859LL
, 664LL
, 985LL
, 1257LL
, 746LL
, 693LL
, 732LL
, 1877LL
, 924LL
, 937LL
, 1100LL
, 1083LL
, 1366LL
, 1105LL
, 1433LL
, 1122LL
, 1118LL
, 1131LL
, 1724LL
, 1127LL
, 1163LL
, 1320LL
, 1167LL
, 1769LL
, 1335LL
, 2179LL
, 1357LL
, 1425LL
, 1478LL
, 2183LL
, 1899LL
, 2855LL
, 2440LL
, 1861LL
, 2037LL
, 2205LL
, 2294LL
, 2227LL
, 2285LL
, 2438LL
, 3339LL
, 2451LL
, 2290LL
, 2487LL
, 2330LL
, 3493LL
, 2502LL
, 2760LL
, 4406LL
, 2692LL
, 2782LL
, 2835LL
, 2903LL
, 4819LL
, 3760LL
, 4665LL
, 6870LL
, 4714LL
, 4989LL
, 4264LL
, 8482LL
, 6247LL
, 4512LL
, 6595LL
, 4620LL
, 4741LL
, 4781LL
, 9770LL
, 4817LL
, 9406LL
, 5194LL
, 5262LL
, 5452LL
, 5474LL
, 10646LL
, 8425LL
, 5738LL
, 10011LL
, 9083LL
, 8024LL
, 9730LL
, 8978LL
, 8776LL
, 10441LL
, 10867LL
, 9132LL
, 9253LL
, 15427LL
, 9361LL
, 9401LL
, 9522LL
, 19417LL
, 10291LL
, 10079LL
, 10456LL
, 14535LL
, 14996LL
, 10926LL
, 11212LL
, 18339LL
, 14716LL
, 13762LL
, 16800LL
, 17002LL
, 19842LL
, 18029LL
, 19988LL
, 28418LL
, 18385LL
, 18493LL
, 37550LL
, 18614LL
, 18762LL
, 18883LL
, 18923LL
, 24238LL
, 20370LL
, 28297LL
, 32874LL
, 25461LL
, 22138LL
, 29419LL
, 24688LL
, 24974LL
, 33209LL
, 30764LL
, 44384LL
, 33802LL
, 35031LL
, 55019LL
, 36414LL
, 50556LL
, 50435LL
, 37147LL
, 37416LL
, 37497LL
, 49526LL
, 37685LL
, 47112LL
, 39293LL
, 49212LL
, 45058LL
, 74477LL
, 46826LL
, 70949LL
, 82555LL
, 84358LL
, 119702LL
, 70032LL
, 81800LL
, 80089LL
, 68833LL
, 70216LL
, 71445LL
, 74099LL
, 73911LL
, 74563LL
, 74644LL
, 75182LL
, 194346LL
, 76790LL
, 82743LL
, 109130LL
, 119157LL
, 143310LL
, 91884LL
, 113891LL
, 142394LL
, 115659LL
, 185920LL
, 184107LL
, 138865LL
, 139049LL
, 142932LL
, 149281LL
, 146008LL
, 140278LL
, 141661LL
, 146627LL
, 167066LL
, 151353LL
, 201014LL
, 225675LL
, 229370LL
, 430384LL
, 243856LL
, 174627LL
, 205775LL
, 230749LL
, 207543LL
, 241165LL
, 229550LL
, 254524LL
, 254708LL
, 277914LL
, 279143LL
, 288940LL
, 372302LL
, 281939LL
, 295908LL
, 448708LL
, 286905LL
, 293014LL
, 541613LL
, 654241LL
, 650216LL
, 403997LL
, 380402LL
, 1191829LL
, 382170LL
, 664109LL
, 404177LL
, 460299LL
, 517654LL
, 437093LL
, 484074LL
, 557057LL
, 543464LL
, 572157LL
, 568083LL
, 561082LL
, 568844LL
, 579919LL
, 678078LL
, 1078736LL
, 667307LL
, 669075LL
, 673416LL
, 762572LL
, 1077593LL
, 784399LL
, 1482733LL
, 784579LL
, 786347LL
, 841270LL
, 864476LL
, 1106168LL
, 921167LL
, 954747LL
, 980557LL
, 1045156LL
, 1358504LL
, 2051577LL
, 1129165LL
, 1129926LL
, 1141001LL
, 1148763LL
, 1247226LL
, 1336382LL
, 1537892LL
, 1340723LL
, 1342491LL
, 1435988LL
, 1546971LL
, 1568978LL
, 1570746LL
, 2278689LL
, 1707514LL
, 1627617LL
, 1705746LL
, 2062168LL
, 2527528LL
, 2175082LL
, 2025713LL
, 2676136LL
, 2270166LL
, 2259091LL
, 2465547LL
, 2270927LL
, 2711747LL
, 4303753LL
, 3963516LL
, 3046469LL
, 3063605LL
, 2968340LL
, 2683214LL
, 4851218LL
, 4982674LL
, 5305560LL
, 3274724LL
, 3198363LL
, 3333363LL
, 3335131LL
, 3886708LL
, 3731459LL
, 4087881LL
, 6358047LL
, 4200795LL
, 4491260LL
, 4529257LL
, 4530018LL
, 7459600LL
, 4736474LL
, 4954141LL
, 7423012LL
, 5651554LL
, 6016577LL
, 6379832LL
, 5746819LL
, 5881577LL
, 6609855LL
, 6473087LL
, 9936815LL
, 9266492LL
, 6608087LL
, 12464855LL
, 12413741LL
, 7066590LL
, 15283069LL
, 7819340LL
, 8288676LL
, 8692055LL
, 9484159LL
, 9265731LL
, 9059275LL
, 10970718LL
, 10483293LL
, 14918046LL
, 10605695LL
, 11398373LL
, 21524130LL
, 11628396LL
, 12126651LL
, 16332321LL
, 12354664LL
, 13081174LL
, 13539677LL
, 14885930LL
, 15873818LL
, 18543434LL
, 17085071LL
, 15355266LL
, 15758645LL
, 16108016LL
, 16511395LL
, 16980731LL
, 17751330LL
, 28113309LL
, 18325006LL
, 22234091LL
, 21454011LL
, 32958889LL
, 22004068LL
, 22732346LL
, 33580662LL
, 28866059LL
, 31624608LL
, 24481315LL
, 25435838LL
, 25894341LL
, 30061905LL
, 28425607LL
, 30241196LL
, 36868440LL
, 38745486LL
, 31113911LL
, 55726217LL
, 31866661LL
, 64072800LL
, 41947233LL
, 34732061LL
, 36076336LL
, 57518949LL
, 39779017LL
, 43458079LL
, 44186357LL
, 46485383LL
, 47213661LL
, 50375656LL
, 68312723LL
, 92794038LL
, 70020213LL
, 59213376LL
, 96081816LL
, 54319948LL
, 58487512LL
, 58666803LL
, 80616852LL
, 74511078LL
, 62980572LL
, 67942997LL
, 78023569LL
, 78190140LL
, 70808397LL
, 76679294LL
, 75855353LL
, 90154673LL
, 83237096LL
, 113533324LL
, 121481648LL
, 90671740LL
, 97589317LL
, 101533609LL
, 109589032LL
, 112807460LL
, 141004141LL
, 172100395LL
, 112986751LL
, 208947138LL
, 161260665LL
, 223015257LL
, 121647375LL
, 187612601LL
, 235180699LL
, 147487691LL
, 168344813LL
, 204205064LL
, 146663750LL
, 152534647LL
, 159092449LL
, 166010026LL
, 210576068LL
, 312673776LL
, 188261057LL
, 192205349LL
, 248197359LL
, 199122926LL
, 369668517LL
, 222396492LL
, 259650501LL
, 253990892LL
, 234634126LL
, 395894791LL
, 464566960LL
, 307924415LL
, 268311125LL
, 289992188LL
, 452402423LL
, 294151441LL
, 572324277LL
, 363297513LL
, 460516474LL
, 516508484LL
, 311627096LL
, 354271083LL
, 387383983LL
, 432972560LL
, 470593851LL
, 617288405LL
, 433757052LL
, 630528917LL
, 608261975LL
, 549642689LL
, 457030618LL
, 553801942LL
, 983399741LL
, 502945251LL
, 558303313LL
, 562462566LL
, 648422524LL
, 584143629LL
, 601619284LL
, 699011079LL
, 879805997LL
, 530627549LL
, 665898179LL
, 1202224466LL
, 741655066LL
, 928915501LL
, 787243643LL
, 890787670LL
, 1133474168LL
, 904350903LL
, 1324544722LL
, 1209881259LL
, 959975869LL
, 987658167LL
, 1006673307LL
, 1010832560LL
, 1033572800LL
, 1061248564LL
, 1087088880LL
, 1088930862LL
, 1093090115LL
, 1114771178LL
, 1132246833LL
, 1196525728LL
, 1453141822LL
, 1272282615LL
, 1317871192LL
, 1938180794LL
, 1691594546LL
, 1528898709LL
, 1678031313LL
, 1902014821LL
, 3148062053LL
, 1993548669LL
, 1864326772LL
, 2017505867LL
, 1966649176LL
, 1947634036LL
, 1994331474LL
, 2094821364LL
, 2072081124LL
, 2257774292LL
, 2148337444LL
, 2176019742LL
, 3350864407LL
, 2311296906LL
, 3639228582LL
, 2328772561LL
, 2771013014LL
, 2846769901LL
, 3009465738LL
, 3182197964LL
, 3623720073LL
, 3206930022LL
, 3522447378LL
, 3542358085LL
, 3766341593LL
, 3811960808LL
, 4205408328LL
, 3830975948LL
, 3914283212LL
, 3941965510LL
, 6531913116LL
, 4066412598LL
, 5158066807LL
, 4220418568LL
, 4433794034LL
, 4324357186LL
, 6140733369LL
, 5099785575LL
, 4640069467LL
, 6658730709LL
, 5175542462LL
, 6389127986LL
, 5856235639LL
, 6191663702LL
, 7484323595LL
, 6729377400LL
, 11887444207LL
, 7608770683LL
, 7308699678LL
, 7597317541LL
, 7642936756LL
, 9739855042LL
, 8266322696LL
, 7856248722LL
, 8654212602LL
, 11704742163LL
, 8286831166LL
, 11369446867LL
, 8544775754LL
, 9815611929LL
, 10516020888LL
, 10275328037LL
, 10496305106LL
, 11029197453LL
, 14478494868LL
, 11031778101LL
, 12245363625LL
, 15340572317LL
, 12921041102LL
, 14213700995LL
, 14038077078LL
, 14906017219LL
, 14917470361LL
, 14951636434LL
, 15240254297LL
, 18102443095LL
, 21304525490LL
, 18360387683LL
, 16143079888LL
, 19316028619LL
, 16831606920LL
, 18562159203LL
, 18820103791LL
, 19041080860LL
, 25067274531LL
, 22520691662LL
, 29378649395LL
, 21525502559LL
, 27172277341LL
, 23277141726LL
, 48476802831LL
, 25166404727LL
, 26959118180LL
, 43416726473LL
, 28251778073LL
, 40018910965LL
, 29823487580LL
, 29869106795LL
, 30191890731LL
, 32974686808LL
, 34245522983LL
, 35393766123LL
, 34503467571LL
, 34705239091LL
, 38136132410LL
, 35872687780LL
, 41082850865LL
, 47292858933LL
, 40566583419LL
, 44046194221LL
, 46691907286LL
, 44802644285LL
, 69208706662LL
, 48443546453LL
, 55035511522LL
, 52125522907LL
, 53418182800LL
, 60060997526LL
, 80196410408LL
, 58075265653LL
, 91049952461LL
, 78291717204LL
, 62843793603LL
, 64897129822LL
, 67220209791LL
, 68950762074LL
, 69897233694LL
, 78549661792LL
, 78702715829LL
, 104863641811LL
, 76439271199LL
, 81649434284LL
, 91339053154LL
, 84612777640LL
, 95135453739LL
, 145390033273LL
, 96928167192LL
, 101861729253LL
, 100569069360LL
, 125295475444LL
, 105543705707LL
, 185740116115LL
, 118136263179LL
, 122972395475LL
, 131794555677LL
, 127740923425LL
, 130064003394LL
, 132117339613LL
, 147500423866LL
, 136170971865LL
, 138847995768LL
, 157252377621LL
, 220783749505LL
, 155141987028LL
, 268288311478LL
, 161052048839LL
, 365216478670LL
, 212353701065LL
, 179748231379LL
, 497011034347LL
, 273278250207LL
, 207405434960LL
, 255359478838LL
, 206112775067LL
, 275388640800LL
, 223679968886LL
, 270472819341LL
, 402267375018LL
, 250713318900LL
, 767483853688LL
, 257804926819LL
, 387476818451LL
, 270965335381LL
, 275018967633LL
, 318304426460LL
, 296100373389LL
, 312394364649LL
, 428420237235LL
, 316194035867LL
, 340800280218LL
, 367164823906LL
, 506072797738LL
, 703808878035LL
, 385861006446LL
, 413518210027LL
, 481501415867LL
, 1153344860134LL
, 499068609686LL
, 429792743953LL
, 474393287786LL
, 481484895705LL
, 1197276597641LL
, 508518245719LL
, 664231528927LL
, 699385572616LL
, 528770262200LL
, 1022113304495LL
, 615819247851LL
, 571119341022LL
, 634498462327LL
, 608494738038LL
, 780683033933LL
, 656994316085LL
, 887911497813LL
, 726661286664LL
, 1232734084402LL
, 1029337457878LL
, 799379216473LL
, 884929616132LL
, 928861353639LL
, 904186031739LL
, 1661863105853LL
, 911277639658LL
, 1393447861851LL
, 1235179532383LL
, 1457631615839LL
, 1117012983757LL
, 1896965613329LL
, 1351802374955LL
, 1297780627686LL
, 1099889603222LL
, 1179614079060LL
, 2332623687624LL
, 1630847318403LL
, 1899268819695LL
, 1880572637155LL
, 1383655602749LL
, 1544905813898LL
, 1526040503137LL
, 1611590902796LL
, 1710656856131LL
, 1684308832605LL
, 1703565248212LL
, 1789115647871LL
, 2649583002641LL
, 1815463671397LL
, 2011167242880LL
, 3156496716694LL
, 2296627062817LL
, 2414793611443LL
, 3199119274146LL
, 2705654582197LL
, 2279503682282LL
, 5098388093841LL
, 2397670230908LL
, 2483545205971LL
, 2883179327272LL
, 2909696105886LL
, 3499772504002LL
, 2928561416647LL
, 4009585709108LL
, 5495746336963LL
, 3070946317035LL
, 4175623505778LL
, 3295899735401LL
, 5571290328137LL
, 5280849558180LL
, 3492680896083LL
, 9456473063958LL
, 6205595841287LL
, 3826630914277LL
, 7496058324749LL
, 5179806390089LL
, 4694297293725LL
, 6590417117221LL
, 4881215436879LL
, 5189199788168LL
, 4677173913190LL
, 5326231647555LL
, 5307366336794LL
, 5366724533243LL
, 5792875433158LL
, 7990197029126LL
, 5999507733682LL
, 6224461152048LL
, 6366846052436LL
, 9276542158322LL
, 11505310710228LL
, 8475706125490LL
, 6788580631484LL
, 11871266675401LL
, 15264286756974LL
, 9859526948519LL
, 15823319116394LL
, 10020528941280LL
, 8503804827467LL
, 9371471206915LL
, 9558389350069LL
, 9575512730604LL
, 14697702854470LL
, 9866373701358LL
, 9984540249984LL
, 10003405560745LL
, 10633597984349LL
, 15370978940597LL
, 16002913294427LL
, 13155426683920LL
, 13013041783532LL
, 23846685066087LL
, 12591307204484LL
, 15292385458951LL
, 24568927617273LL
, 16160051838399LL
, 19987945810729LL
, 16346969981553LL
, 17875276034382LL
, 20618138234333LL
, 19725900649877LL
, 19424763051427LL
, 18062194177536LL
, 18079317558071LL
, 18946983937519LL
, 19441886431962LL
, 20209110714953LL
, 22594712765229LL
, 19850913951342LL
, 36437992270571LL
, 20637003545094LL
, 23224905188833LL
, 28751359042883LL
, 29158339978347LL
, 33364537398873LL
, 25604348988016LL
, 27883692663435LL
, 35816212393317LL
, 31452437297350LL
, 32507021819952LL
, 37504080609498LL
, 34409164159089LL
, 34222246015935LL
, 35937470211918LL
, 40362904194971LL
, 55258098825279LL
, 37913108128878LL
, 73320293002815LL
, 37026301495590LL
, 38388870369481LL
, 43075819140175LL
, 59025873914575LL
, 48520696208529LL
, 40487917496436LL
, 43861908733927LL
, 46241352533110LL
, 60610777275697LL
, 63993219357497LL
, 70159716227853LL
, 53488041651451LL
, 57056786285366LL
, 59336129960785LL
, 70038458409252LL
, 63959459117302LL
, 66729267835887LL
, 68631410175024LL
, 70346634371007LL
, 129372508285582LL
, 72963771707508LL
, 75415171865071LL
, 74939409624468LL
, 83267654028700LL
};

auto const i = first_invalid(input, 25);
auto const [l, h] = get_range_boundaries(input, i);
fmt::print("first invalid is {}\n", i);
fmt::print("weakness is {}, made from {} + {}\n", l + h, l, h);

}